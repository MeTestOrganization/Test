name: "Design tokens sync"
run-name: "Design tokens sync"

on:
  pull_request:
    branches: [main]
    types: [opened, reopened, synchronize]

jobs:
  process-fork:
    if: ${{ github.event.pull_request.head.repo.fork == true }}
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - name: Checkout main repo
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 9

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: 18
          cache: pnpm

      - name: Setup Git bot user
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch PR changes and save fork info
        run: |
          # –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–æ—Ä–∫–µ –≤ GITHUB_ENV
          echo "FORK_OWNER=${{ github.event.pull_request.head.repo.owner.login }}" >> $GITHUB_ENV
          echo "FORK_REPO=${{ github.event.pull_request.head.repo.name }}" >> $GITHUB_ENV
          echo "FORK_BRANCH=${{ github.event.pull_request.head.ref }}" >> $GITHUB_ENV

          # –û—Ç–ª–∞–¥–æ—á–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
          echo "Fork: ${{ github.event.pull_request.head.repo.owner.login }}/${{ github.event.pull_request.head.repo.name }}"
          echo "Branch: ${{ github.event.pull_request.head.ref }}"

          # –ü–æ–ª—É—á–∞–µ–º –∏–∑–º–µ–Ω–µ–Ω–∏—è –∏–∑ PR
          git fetch origin pull/${{ github.event.pull_request.number }}/head:pr-branch
          git checkout pr-branch

      - name: Check for tokens.json
        id: check-tokens
        run: |
          if [ -f "tokens.json" ]; then
            echo "‚úÖ tokens.json found"
            echo "has_tokens=true" >> $GITHUB_OUTPUT
          else
            echo "‚ùå tokens.json not found"
            echo "has_tokens=false" >> $GITHUB_OUTPUT
          fi

      - name: Generate CSS variables
        if: steps.check-tokens.outputs.has_tokens == 'true'
        id: generate-css
        run: |
          pnpm i --frozen-lockfile
          pnpm build:tokens

          # –ü—Ä–æ–≤–µ—Ä—è–µ–º –∏–∑–º–µ–Ω–∏–ª–æ—Å—å –ª–∏ —á—Ç–æ-—Ç–æ
          if git diff --quiet; then
            echo "‚úÖ No CSS changes needed"
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ CSS changes detected"
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Commit and push to fork
        if: steps.generate-css.outputs.has_changes == 'true'
        env:
          FORK_PAT: ${{ secrets.FORK_PAT_TOKEN }}
        run: |
          # –ö–æ–º–º–∏—Ç–∏–º –∏–∑–º–µ–Ω–µ–Ω–∏—è
          git add .
          git commit -m "üé® Auto-generated CSS variables from tokens.json

          Auto-updated by GitHub Actions from PR #${{ github.event.pull_request.number }}"

          # –û—Ç–ª–∞–¥–∫–∞
          echo "=== Push Info ==="
          echo "Fork Owner: $FORK_OWNER"
          echo "Fork Repo: $FORK_REPO"
          echo "Fork Branch: $FORK_BRANCH"
          echo "================="

          # –ü—É—à–∏–º –≤ —Ñ–æ—Ä–∫
          echo "‚úÖ Pushing to fork: $FORK_OWNER/$FORK_REPO:$FORK_BRANCH"
          git push https://x-access-token:${FORK_PAT}@github.com/$FORK_OWNER/$FORK_REPO.git HEAD:$FORK_BRANCH

      - name: Comment on PR
        if: steps.generate-css.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh pr comment ${{ github.event.pull_request.number }} \
            --body "## ‚úÖ CSS –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

          –ò–∑–º–µ–Ω–µ–Ω–∏—è –±—ã–ª–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã –≤ –≤–∞—à PR.

          –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø—Ä–æ–≤–µ—Ä—å—Ç–µ –æ–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ —Ñ–∞–π–ª—ã –∏ –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–Ω–µ—Å–∏—Ç–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è.

          ---
          ü§ñ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –æ—Ç GitHub Actions"
